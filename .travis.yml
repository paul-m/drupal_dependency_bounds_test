sudo: false
language: php
php:
  - 5.5

before_script:
  - git clone --branch 8.4.x https://git.drupal.org/project/drupal.git
  - cd drupal
  # Perform a Composer install. Composer update --prefer-lowest doesn't merge
  # properly with wikimedia/composer-merge-plugin unless there is already a
  # vendor/.
  - composer install --no-progress --prefer-dist

script:
  - wget https://gist.githubusercontent.com/paul-m/d9c79d03f5562a20367de4c2293760bc/raw/f6ba0a2892d1a19dd7e4a1fe1e468e8cb676890c/composer_updates.patch
  - git apply composer_updates.patch
  # Update with --prefer-lowest.
  - composer update --prefer-lowest --no-progress --prefer-dist
  # Run only unit tests because they have no dependencies to set up.
  - ./vendor/bin/phpunit -c core/ --testsuite unit
  # Update.
  - composer update --no-progress --prefer-dist
  # Re-run the tests.
  - ./vendor/bin/phpunit -c core/ --testsuite unit
